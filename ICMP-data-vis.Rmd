---
title: "ICMP data visualisation"
author: "Bevan Weir"
date: "data as of 21 October 2021"
output:
  html_document: default
  pdf_document: default
subject: Nationally significant collections
affiliation: Manaaki Whenua - Landcare Research
---

```{r setup, include=FALSE}

#load all packages needed
library(tidyverse)
library(ggplot2)
library(lubridate)
library(gridExtra)
library(maps)
library(mapdata)
library(dplyr)

```

## Introduction

This is an R Markdown document for statistics derived from specimen data of the ICMP culture collection <https://www.landcareresearch.co.nz/icmp>. This is an experimental showcase of presenting visulisations of data analysed in R in a user-friendly format.

This data excludes all deaccessioned cultures, but includes different specimen security levels such as 'confidential'.

```{r import, include=FALSE}
#import the files
ICMP.dump.initial <- read.csv("ICMP-export-21-oct-2021.csv", header=TRUE, sep=",")

#subset the data
#tidyverse way of sub setting - remove viruses and deaccessioned cultures
ICMP.dump <- ICMP.dump.initial %>%
  filter(SpecimenType == "Bacterial Culture" | 
           SpecimenType == "Chromist Culture" | 
           SpecimenType == "Fungal Culture" | 
           SpecimenType == "Yeast Culture") %>%
  filter(Deaccessioned == "false")
```

## General stats

The ICMP has `r getRversion()` cultures


Here include:

-   number of specimens
-   number at each security level ?
-   NZ versus overseas

```{r tables, echo=TRUE}

library(knitr)
ktable.specimen2 <- count(ICMP.dump,SpecimenType) #dpylr
kable(ktable.specimen2, caption = "Basic stats") #knitr

```

## Type cultures

The ICMP has a number of type cultures.

```{r types, echo=TRUE}

ICMP.types <- subset(ICMP.dump,!(TypeStatus == ""))
table(ICMP.types$SpecimenType)

```

There are different 'kinds' of types. Bacterial types are 'type strains', bacterial pathovars are 'pathotype strains'. Fungal type cultures may have been isolated from a type specimen (e.g. from PDD) and are thus 'ex types'.

```{r types chart, echo=FALSE}

#barchart of all ICMP types sorted by 'kind' of type, coloured by kind of organism
positions <- c("Type strain", "Pathotype strain", "Neopathotype strain", "Type", "ex Type",  "Holotype", "ex Holotype", "Paratype", "ex Paratype", "Isotype", "Neotype", "ex Neotype", "Epitype", "ex Epitype", "Syntype", "Reference strain")
ggplot(ICMP.types, aes(TypeStatus, fill=SpecimenType)) +
  labs(title = "Types in the ICMP culture collection") +
  labs(x = "'Kind' of type", y = "number of cultures") +
  geom_bar() + 
  coord_flip() +
  scale_fill_brewer(palette = "Set2") +
  scale_x_discrete(limits = positions)

```

## Extended specimen data

Extended specimen data is data beyond the basic taxonomic and and location. See: <https://academic.oup.com/bioscience/article/70/1/23/5637849> The charts below show the proportion of ICMP cultures that have DNA sequences lodged in GenBank global repository, images (usually of culture plates), and when a culture is specifically cited in literature.

```{r Extended specimen data, echo=FALSE}

#sub set out the interesting columns using "select" in dpylr
library(dplyr)
only.ext.specimen <- select(ICMP.dump, "AccessionNumber","SpecimenType", "GenBank", "Literature", "Images")

#create two new columns using "pivot_longer" into a tibble table
library(tidyr)
tibble.ext.specimen <-pivot_longer(only.ext.specimen, cols=3:5, names_to="ExtendedSpecimen", values_to="present")

# ** Cultures with extended specimen data
ggplot(tibble.ext.specimen, aes(ExtendedSpecimen, fill=present)) +
  labs(title = "Cultures with GenBank DNA sequences, images, and citations in literature") +
  labs(x = "extended specimen data", y = "proportion of cultures with this data") +
  scale_fill_brewer(palette = "Paired") +
  geom_bar(position = "fill")

```

This data can be split by the type of specimen (Bacteria, Fungi, Chromist, Yeast) to show the relative proportions of extended specimen data for each of these. 

```{r Extended specimen data 2, echo=FALSE}

# ** Cultures with extended specimen data by ExtendedSpecimen with SpecimenType facet
ggplot(tibble.ext.specimen, aes(ExtendedSpecimen, fill=present)) +
  labs(title = "Cultures with GenBank DNA sequences, images, and citations in literature") +
  labs(x = "Taxon", y = "number of isolates") +
  scale_fill_brewer(palette = "Paired") +
  geom_bar() +
  facet_grid(cols = vars(SpecimenType))

```

## Geography

The geographic location of specimens is important. Most ICMP cultures were isolated from Aotearoa New Zealand, but

```{r top countries, echo=FALSE}

positions <- c("New Zealand", "United States", "Australia", "United Kingdom", "Brazil", "Japan", "Thailand", "China", "India",  "Italy")

ICMP.10county <- subset(ICMP.dump, (Country == "New Zealand" | Country == "United States" | Country == "Australia" | Country == "United Kingdom" | Country == "Brazil" | Country == "Thailand" | Country == "China" | Country == "Japan" | Country == "India" | Country == "Italy"))

ggplot(ICMP.10county, aes(Country, fill=SpecimenType)) +
  labs(title = "Top 10 Countries in the ICMP") +
  labs(x = "Country", y = "number of cultures") +
  theme(axis.text.x=element_text(angle=-90, hjust=0)) +
  geom_bar() +
  coord_flip() +
  scale_fill_brewer(palette = "Set2") +
  scale_x_discrete(limits = positions)
  
```

```{r top NZ area codes, echo=FALSE}

#New Zealand Area codes
ICMP.nz <- subset(ICMP.dump,(Country == "New Zealand"))

positions <- c("New Zealand", "Campbell Island", "Auckland Islands", "Snares Islands", "Chatham Islands",  "Stewart Island", "Southland", "Fiordland", "Dunedin", "Central Otago", "Otago Lakes", "South Canterbury", "Mackenzie", "Westland", "Mid Canterbury", "North Canterbury", "Buller", "Kaikoura", "Marlborough", "Nelson", "Marlborough Sounds", "South Island", "Wairarapa", "Wellington", "Hawkes Bay", "Rangitikei", "Wanganui", "Gisborne", "Taupo", "Taranaki", "Bay of Plenty", "Waikato", "Coromandel", "Auckland", "Northland", "North Island", "Three Kings Islands", "Kermadec Islands")

ggplot(ICMP.nz, aes(NZAreaCode)) +
  labs(title = "ICMP cultures by NZ region") +
  labs(x = "Crosby Region", y = "number of cultures") +
  theme(axis.text.x=element_text(angle=-90, hjust=0)) +
  geom_bar() +
  coord_flip() +
  scale_x_discrete(limits = positions)

```

### world map

ICMP cultures were isolated from around the world.

```{r world map, echo=FALSE}

world <- map_data("world")
ggplot() + 
  geom_polygon(data = world, aes(x=long, y = lat, group = group), fill = "grey") +
  theme_void() +
  geom_point(data = ICMP.dump, aes(x = DecimalLong, y = DecimalLat), color = "red", size = 1, alpha = 0.2) +
  coord_fixed(1.3)
  
```

## Timeline

```{r all isolated dates chart, echo=FALSE}

#standard all ICMP overtime stats faceted

date.isolated <-ymd(ICMP.dump$IsolationDateISO, truncated = 1)
ggplot(ICMP.dump, aes(date.isolated, fill = SpecimenType)) +
  labs(title = "Isolation dates of ICMP cultures") +
  labs(x = "Date of isolation", y =  "Number of cultures" , fill = "") +
  scale_fill_brewer(palette = "Set2") +
  geom_histogram(binwidth=365.25, show.legend = FALSE) +
  facet_grid(SpecimenType ~ .)

```

### Isolation month

```{r NZ isolated month chart, echo=FALSE}

#new month ICMP culture isolated (in NZ)
attach(ICMP.nz) 
month.isolated <- ymd(ICMP.nz$IsolationDateISO, truncated = 1)
mergemonths <- floor_date(month.isolated, unit = "month")
ggplot(ICMP.nz, aes(month(mergemonths, label = TRUE), fill = SpecimenType)) +
  labs(title = "Isolation month of ICMP cultures from NZ") + 
  labs(x = "Month of isolation", y =  "Number of cultures" , fill = "") +
  scale_fill_brewer(palette = "Set2") +
  geom_bar() + 
  scale_x_discrete(na.translate = FALSE)  # this removes NAs

```

## Curation stats

These stats may be useful for curation or data checking.

### Last updated user

```{r last updated user chart, echo=FALSE}

#pie chart by last updated user
ICMP.dump$LastUpdatedBy <- sapply(ICMP.dump$UpdatedBy, tolower)
ggplot(ICMP.dump, aes(x=factor(1), fill=LastUpdatedBy)) +
  labs(title = "Last user to update an ICMP record") +
  geom_bar(width = 1) +
  coord_polar("y") +
  theme_void() +
  scale_fill_brewer(palette = "Paired")

```
